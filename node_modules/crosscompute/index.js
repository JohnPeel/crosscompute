(function() {
  var $run_tool_form = $('form.result');

  if ($run_tool_form.length) {

    var $run_tool_button = $run_tool_form.find('.run');
    var $result = $('div.result');

    function run_tool() {
      var $button = $run_tool_button.prop('disabled', true),
          $form = $button.parent('form').trigger('updated.cc'),
          button_text = $button.text();
      $button.text('Running...');
      $.ajax({
        type: 'POST',
        url: CC.tool_json_url,
        data: $form.serialize(),
        error: function(jqXHR) {
          $form.trigger('failed.cc', jqXHR);
          $button.prop('disabled', false).text(button_text);
        },
        success: function(d) {
          location.href = d.result_url;
        }
      });
    }

    $run_tool_form.submit(function(e) {
      e.preventDefault();
    }).keydown(function(e) {
      if (e.keyCode == 13 && e.shiftKey) {
        run_tool();
      }
    });

    $run_tool_button.click(run_tool);

    if ($result.length) {
      setTimeout(function() {
        var offset = $result.offset();
        scrollTo(offset.left, offset.top);
      }, 1);
    } else {
      $run_tool_form.find('.form-group input').first().focus();
    }

  }

  $('[data-toggle="popover"]').popover({
    'trigger': 'click hover focus'
  });

}());
