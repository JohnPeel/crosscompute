(function() {
  var $run_tool_form = $('#arguments');
  var $run_tool_button = $run_tool_form.find('.run');

  function run_tool() {
    var $button = $run_tool_button.prop('disabled', true),
        $form = $button.parent('form').trigger('updated.cc'),
        button_text = $button.text();
    $button.text('Running...');
    $.ajax({
      type: 'POST',
      url: CC.tool_json_url,
      data: $form.serialize(),
      error: function(jqXHR) {
        var d = jqXHR.responseJSON;
        $form.trigger('failed.cc', d);
        $button.prop('disabled', false).text(button_text);
      },
      success: function(d) {
        location.href = d.result_url;
      }
    });
  }

  $run_tool_form.submit(function(e) {
    e.preventDefault();
  }).keydown(function(e) {
    if (e.keyCode == 13 && e.shiftKey) {
      run_tool();
    }
  });

  $run_tool_button.click(run_tool);

  $('[data-toggle="popover"]').popover({
    'trigger': 'click hover focus'
  });
}());
