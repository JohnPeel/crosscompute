{% extends 'base.jinja2' %}

{% block body_js %}
let echoSource, serverTime, reconnectionId

function connect() {
  echoSource = new EventSource('{{ BASE_URI }}{{ ECHOES_ROUTE }}')

  echoSource.onopen = function() {
    clearTimeout(reconnectionId)
  }

  echoSource.onmessage = function(message) {
    const messageData = message.data
    if (messageData != serverTime) {
      if (serverTime) {
        location.reload()
      }
      serverTime = messageData
    }
  }

  echoSource.onerror = function() {
    echoSource.close()
    clearTimeout(reconnectionId)
    reconnectionId = setTimeout(connect, 1000)
  }
}

connect()
{{ super() }}
{%- endblock %}
